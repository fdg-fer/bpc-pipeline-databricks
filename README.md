# Projeto BPC - An√°lise de Judicializa√ß√£o, Cobertura e Prazos

O Benef√≠cio de Presta√ß√£o Continuada (BPC) √© um dos temas mais debatidos no √¢mbito da assist√™ncia social no Brasil. Voltado para pessoas idosas ou com defici√™ncia em situa√ß√£o de vulnerabilidade, o BPC se diferencia de benef√≠cios previdenci√°rios como aposentadorias ou aux√≠lios por incapacidade, pois n√£o exige contribui√ß√£o pr√©via do benefici√°rio. Essa caracter√≠stica, somada ao seu impacto social e or√ßament√°rio, o torna alvo frequente de debates pol√≠ticos, ajustes fiscais e mudan√ßas legislativas.

A concess√£o do BPC pode ocorrer de duas formas: **administrativa**, diretamente pelo INSS, ou **judicial**, quando o pedido inicial √© negado e o requerente recorre √† Justi√ßa. A judicializa√ß√£o representa n√£o apenas um aumento da demanda para o Judici√°rio, mas tamb√©m uma oportunidade para escrit√≥rios e profissionais jur√≠dicos identificarem regi√µes com maior potencial de atua√ß√£o.

Compreender **quais regi√µes apresentam √≠ndices elevados de judicializa√ß√£o e como se comportam os indicadores de cobertura e prazos** permite tomadas de decis√£o mais estrat√©gicas. Por exemplo:

  - No **BPC-Idoso**, que possui menos barreiras t√©cnicas, regi√µes com alta judicializa√ß√£o e baixa cobertura podem sinalizar alto potencial de novas a√ß√µes.

  - No **BPC-Deficiente**, que exige per√≠cias e laudos mais complexos, indicadores como prazos m√©dios e tipo de decis√£o ajudam a identificar √°reas com maior necessidade de apoio jur√≠dico especializado.

Este projeto prop√µe uma solu√ß√£o baseada em indicadores estruturados e atualizados, permitindo monitorar a situa√ß√£o do BPC por unidade federativa e modalidade, ajudando gestores e advogados a agir de forma mais direcionada e eficaz.

---

# Objetivo do Projeto
Este pipeline foi desenvolvido para monitorar e analisar concess√µes do Benef√≠cio de Presta√ß√£o Continuada (BPC), com foco em pedidos cujo processo iniciou a partir de 2024 e foram concedidos entre janeiro e junho de 2025.
A an√°lise permite identificar padr√µes de concess√£o, prazos e cobertura territorial, fornecendo informa√ß√µes estrat√©gicas para √°reas como advocacia previdenci√°ria, √≥rg√£os p√∫blicos e estudos de pol√≠ticas sociais
---

## Tecnologias Utilizadas 

- **Databricks Free Edition** (ambiente de notebooks)
- **Pyspark, Python e SQL** (tranforma√ß√µes, limpeza, an√°lise explorat√≥ria, c√°lculos)
- **Power BI**: (visualiza√ß√£o final dos dados)
- **GitHub** (versionamento e documenta√ß√£o - integrado ao Databricks)

---

## Fonte de Dados

Os dados utilizados no projeto foram extra√≠dos de tr√™s principais fontes p√∫plicas:

- **INSS**: Dados de concess√µes do BPC por m√™s, dispon√≠vel em csv.
 [Fonte: INSS - Dados Abertos](https://dadosabertos.inss.gov.br/dataset/beneficios-concedidos-plano-de-dados-abertos-jun-2023-a-jun-2025)
  - Quantidade de arquivos: 6 cvs - Concess√µes de jan/25 a jun/25

- **IBGE (Censo 2022)**: Popula√ß√£o total por munic√≠pio, utilizada para c√°lculo de cobertura e identifica√ß√£o do p√∫blico-alvo.  
  [Fonte: Censo IBGE 2022](https://www.ibge.gov.br/estatisticas/sociais/trabalho/22827-censo-demografico-2022.html?=&t=downloads/)
  - Quantidade de arquivos: 1 csv

- **Munic√≠pios/UF/Regi√£o**: Dados de refer√™ncia com c√≥digos de munic√≠pios, sigla UF e regi√£o geogr√°fica.  
  [Fonte: IBGE ‚Äì Tabela de Refer√™ncia Territorial](https://www.ibge.gov.br/geociencias/organizacao-do-territorio/malhas-territoriais/15774-malhas.html/)
  - Quantidade de arquivos: 1 csv

---

## Arquitetura de dados
O pipeline foi estruturado seguindo o modelo **Medallion Architecture (Bronze, Silver, Gold)** que facilita a rastreabilidade, versionamento e reutiliza√ß√£o dos dados em m√∫ltiplos est√°gios.

![Medallion Architecture](<img/medallion.png>)

### Por que usar arquitetura em camadas?

A Medallion Architecture permite:

- **Rastreabilidade**: Cada transforma√ß√£o tem uma origem clara, facilitando auditorias.
- **Reprodutibilidade**: Permite fazer an√°lises com seguran√ßa, a partir dos dados brutos.
- **Separa√ß√£o da responsabilidade**: Cada camada tem um prop√≥sito distinto, facilitando manuten√ß√£o e escabilidade.
- **Versionamento l√≥gico**: A organiza√ß√£o em camadas ajuda a entender a evolu√ß√£o dos dados ao longo do pipeline.

---

## Camadas:

### ü•â Bronze 
- Dados brutos carregados diretamente dos arquivos CSV das fontes p√∫blicas.
- Pouco ou nenhum tratamento.
- Objetivo: manter a vers√£o original para rastreabilidade.

```
# Leitura de todos arquivos csv da pasta benef_conced contidos no volume

df = (
    spark.read.format("csv") 
    .option("header", "true") # se tem cabe√ßalho
    .option("inferSchema", "true") # inferir o schema do arquivo csv
    .option("delimiter", ";") # delimitador do arquivo csv
    .option("encoding", "UTF-8")  # encoding do arquivo csv
    .load("dbfs:/Volumes/portfolio_inss/base_bpc/benef_conced/")
)

from pyspark.sql import functions as F  # Importa fun√ß√µes do PySpark
import re  # M√≥dulo para opera√ß√µes com express√µes regulares 

def limpar_nome_coluna(nome):
    
    nome = nome.strip() # Remove espa√ßos no in√≠cio/fim
    nome = re.sub(r"[ ,{}()\n\t=]", "_", nome) # Substitui caracteres especiais por underscore
    nome = re.sub(r"__+", "_", nome) # Remove underscores consecutivos
    nome = nome.strip("_") # Remove underscores no in√≠cio/fim
    return nome.lower() # Converte tudo para min√∫sculas

# Aplica a fun√ß√£o a todas as colunas do DataFrame
df = df.select([F.col(c).alias(limpar_nome_coluna(c)) for c in df.columns]) # Renomeia as colunas


# Grava dados do df na tabela delta na camada bronze 

df.write.format("delta") \
    .mode("overwrite") \
    .saveAsTable("portfolio_inss.bronze.bronze_inss_bpc_2025_01_06")
```
---

### ü•à Silver 
- Aplica√ß√£o de regras de neg√≥cios e limpeza dos dados. 
- Sele√ß√£o de colunas relevantes, padroniza√ß√£o de tipos, nomes e tipo de despacho (administrativo/judicial).


```
# Leitura da tabela delta na camada bronze

df = spark.table("portfolio_inss.bronze.bronze_inss_bpc_2025_01_06")


# Renomeando colunas

df = df.withColumnRenamed('compet√™ncia_concess√£o', 'competencia')\
       .withColumnRenamed('uf', 'uf_julgado')\
       .withColumnRenamed('esp√©cie4', 'beneficio')\
       .withColumnRenamed('dt_ddb', 'dt_despacho')\
       .withColumnRenamed('dt_dib', 'dt_inicio_beneficio')\
       .withColumnRenamed('cid6', 'cid')  


# Convers√£o de datas

df = df.withColumn("competencia", to_date(expr("concat(competencia, '01')"),"yyyyMMdd"))\
        .withColumn("dt_nascimento", to_date(df.dt_nascimento, "dd/MM/yyyy"))\
        .withColumn("dt_despacho", to_date(df.dt_despacho, "dd/MM/yyyy"))\
        .withColumn("dt_inicio_beneficio", to_date(df.dt_inicio_beneficio, "dd/MM/yyyy"))


# Grava dados do df na tabela delta na camada silver

df_result.write.format("delta")\
    .mode("overwrite")\
    .saveAsTable("portfolio_inss.silver.silver_bpc_concessoes")
```

#### Estrutura das Tabelas da Camada Silver
- [Baixar Dicion√°rio Silver](https://github.com/fdg-fer/bpc-pipeline-databricks/blob/main/dic/silver.xlsx)

---
### ü•á Camada Gold

Nesta camada, os dados j√° passaram por limpeza e transforma√ß√µes, estando prontos para **consumo final** em dashboards, relat√≥rios e an√°lises explorat√≥rias.  
A modelagem segue o formato **Star Schema**, com tabelas fato e tabelas dimens√£o, permitindo consultas otimizadas e agrega√ß√µes consistentes.

#### Objetivos
- Consolidar informa√ß√µes calculadas e agregadas.
- Organizar dados para f√°cil integra√ß√£o com ferramentas de BI.
- Garantir consist√™ncia em m√©tricas como **cobertura**, **prazos m√©dios/medianos** e segmenta√ß√µes por UF e p√∫blico-alvo.

A m√©trica de prazo, tempo em que √© requerido e benef√≠cio e at√© a sua concess√£o tem um comportamento bem distinto entre e administrativo judicial, nessa an√°lise explorat√≥ria pode entender melhor 
qual media foi aplicada.
- [An√°lise explorat√≥ria de prazos](https://github.com/fdg-fer/bpc-pipeline-databricks/blob/main/exploratoria_prazos.ipynb)

 
```
# Cria na camada gold a tabela fato_bpc_geral com granularidade por compet√™ncia

query = """

CREATE OR REPLACE TABLE portfolio_inss.gold.gold_fato_bpc_geral (
USING DELTA

  WITH 
  -- C√°lculo dos prazos m√©dios por tipo
  
  prazo_medio AS (
    SELECT
      competencia,
      beneficio,
      tipo_despacho,
      ROUND(avg(dias_ate_despacho), 1) AS prazo_medio,
      ROUND(median(dias_ate_despacho), 1) AS prazo_mediana
    FROM portfolio_inss.silver.silver_bpc_concessoes
    WHERE dt_inicio_beneficio >= '2024-01-01'
    GROUP BY competencia, beneficio, tipo_despacho
  ),

  -- C√°lculo da quantidade por tipo
  qtd_processos AS (
    SELECT
      competencia,
      beneficio,
      SUM(CASE WHEN tipo_despacho = 'administrativo' THEN 1 ELSE 0 END) AS qtd_administrativo,
      SUM(CASE WHEN tipo_despacho = 'judicial' THEN 1 ELSE 0 END) AS qtd_judicial
    FROM portfolio_inss.silver.silver_bpc_concessoes
    WHERE dt_inicio_beneficio >= '2024-01-01'
    GROUP BY competencia, beneficio
  )

  -- Tabela final
  SELECT
    q.competencia,
    q.beneficio,
    q.qtd_administrativo,
    q.qtd_judicial,
    (q.qtd_administrativo + q.qtd_judicial) AS qtd_total_concedido,
    ROUND(q.qtd_judicial / NULLIF((q.qtd_administrativo + q.qtd_judicial), 0), 3) AS pct_judicializacao,
    MAX(CASE WHEN p.tipo_despacho = 'administrativo' THEN p.prazo_mediana END) AS prazo_mediana_adm,
    MAX(CASE WHEN p.tipo_despacho = 'judicial' THEN p.prazo_medio END) AS prazo_medio_jud
  FROM qtd_processos q
  LEFT JOIN prazo_medio p 
    ON q.competencia = p.competencia 
    AND q.beneficio = p.beneficio
  GROUP BY 
    q.competencia,
    q.beneficio,
    q.qtd_administrativo,
    q.qtd_judicial
  ORDER BY
   q.competencia,
   q.beneficio
)
"""
spark.sql(query)
```

#### Estrutura das Tabelas da Camada Gold
- [Baixar Dicion√°rio Gold](https://github.com/fdg-fer/bpc-pipeline-databricks/blob/main/dic/gold.xlsx)

**Tabelas Fato**

As tabelas Fato BPC re√∫nem informa√ß√µes consolidadas sobre solicita√ß√µes e concess√µes do BPC, filtradas de acordo com o crit√©rio temporal definido para a an√°lise: consideram-se apenas processos cuja data de entrada seja igual ou posterior a 01/01/2024.
Esse recorte temporal √© aplicado para assegurar que a an√°lise se concentre em pedidos recentes, possibilitando a avalia√ß√£o de prazos e perfis de concess√£o.

- **Fato BPC Geral** ‚Äì Dados consolidados do BPC em n√≠vel nacional, com m√©tricas de cobertura e prazos.

  ![Fato BPC Geral](<img/fato_bpc_geral.png>)

- **Fato BPC por UF** ‚Äì Mesma granularidade da tabela geral, mas segmentada por Unidade Federativa.

  ![Fato BPC por UF](<img/fato_bpc_uf.png>) 

- **Fato Popula√ß√£o/P√∫blico-alvo** ‚Äì Informa√ß√µes demogr√°ficas e quantitativas sobre o p√∫blico-alvo do benef√≠cio.

  ![Fato Popula√ß√£o](<img/fato_populacao.png>)

**Tabelas Dimens√£o**
- **Dimens√£o Calend√°rio** ‚Äì Datas de refer√™ncia para an√°lises temporais (ano, m√™s, trimestre, etc.).

  ![Dimens√£o Calend√°rio](<img/dim_calendario.png>)

- **Dimens√£o Benef√≠cio** ‚Äì Classifica√ß√£o e tipo de benef√≠cio dentro do BPC.

  ![Dimens√£o Benef√≠cio](<img/dim_beneficio.png>)

- **Dimens√£o UF/Regi√£o** ‚Äì Mapeamento de Unidades Federativas para suas respectivas regi√µes.

  ![Dimens√£o UF/Regi√£o](<img/dim_regiao.png>)

#### Exemplos de Uso
- C√°lculo de cobertura por UF ao longo do tempo.
- Compara√ß√£o de prazos m√©dios administrativos e judiciais.
- Dashboards interativos no Power BI segmentados por regi√£o e p√∫blico.

---

## Fluxo de Transforma√ß√£o Databricks

Abaixo, o fluxo visual que mostra a transforma√ß√£o dos dados da camada Bronze at√© a Gold:

Fluxo de camadas das tabelas -> `gold_fato_bpc_geral` e `gold_fato_bpc_uf`


| Volume               | Bronze                          | Silver                  | Gold                                  |
|:--------------------:|:-------------------------------:|:-----------------------:|:-------------------------------------:|
| `6 arquivos csv`     | `bronze_inss_bpc_2025_01_06`    | `silver_bpc_concessoes` | `gold_fato_bpc_uf` / `gold_fato_bpc_geral` |


  ![Fluxo de Tranforma√ß√£o de tabelas](<img/fluxo_bpc.png>)


Fluxo de camadas das tabelas -> `gold_fato_populacao_bpc`

| Volume          | Bronze                                                         | Silver                                       | Gold                | 
|---------------------|---------------------------------------------------------------------|-------------------------------------------------|--------------------|
|  `2 arquivos csv`   |`bronze_ibge_bronze_censo_2022`/`bronze_ibge_bronze_municipios_ibge`| `silver_ibge_populacao`/`silver_municipios_ibge`| `gold_fato_populacao_bpc`| 


  ![Fluxo de Tranforma√ß√£o de tabelas](<img/fluxo_populacao_bpc.png>)

---


### Vis√µes Gold e Regras de Neg√≥cio

| Tabela                   | Descri√ß√£o                                   | Regra de Neg√≥cio / Filtro                                 |
|--------------------------|---------------------------------------------|-----------------------------------------------------------|
| `gold_fato_bpc_geral`    | BPC concedidos granularidade mensal com share de jucializa√ß√£o, prazos m√©dios     | Considera apenas processos iniciados a partir de 2024 e concedidos entre jan‚Äìjun/2025 |           
| `gold_fato_bpc_uf_` | BPC concedidos com granularidade mensal por UF com share de jucializa√ß√£o, prazos m√©dios | Considera apenas processos iniciados a partir de 2024 e concedidos entre jan‚Äìjun/2025 |
| `gold_fato_bpc_populacao_uf` | Distribui√ß√£o por p√∫blico-alvo baseado na idade por UF | Sem recorte temporal                                       |


**Observa√ß√£o:**  
A distin√ß√£o de recorte temporal √© feita apenas em vis√µes espec√≠ficas para an√°lises recentes. As camadas Bronze e Silver n√£o aplicam esse filtro.


#### Modelagem Star Schema - Power BI

  ![Fluxo de Tranforma√ß√£o de tabelas](<img/schema_pbi.png>)


#### Dashboard 

  No painel, os cards mostram que o prazo judicial teve um aumento de 17% no segundo semestre em rela√ß√£o ao primeiro, refletindo uma tend√™ncia de crescimento mensal constante, conforme a tabela detalhada.
  A concess√£o administrativa tamb√©m cresceu 12% do primeiro para o segundo trimestre.

  Esses indicadores evidenciam uma press√£o crescente tanto na via judicial quanto administrativa, importante para o gestor acompanhar e ajustar estrat√©gias no escrit√≥rio.

  ![Fluxo de Tranforma√ß√£o de tabelas](<dashboard/visao_nacional.png>)

  A vis√£o que mostra o cen√°rio regional ao longo dos meses por Tipo de Benef√≠cio revela alguns pontos importantes na regi√£o Sul. Em Santa Catarina, o n√∫mero absoluto de concess√µes do BPC Idoso √© o menor entre os estados da regi√£o. Al√©m disso, a cobertura por mil habitantes tamb√©m √© relativamente baixa, o que pode revelar uma demanda subatendida.

  Chama aten√ß√£o, ainda, a judicializa√ß√£o relativamente alta nesse tipo de benef√≠cio, mesmo considerando que o BPC Idoso possui uma legisla√ß√£o mais objetiva e com prazos mais curtos, o que normalmente resulta em maior propor√ß√£o de concess√µes administrativas.

  Esse cen√°rio indica uma poss√≠vel maior necessidade de representa√ß√£o profissional para os benefici√°rios do BPC Idoso em Santa Catarina, evidenciando uma oportunidade de neg√≥cio para servi√ßos especializados de assessoria jur√≠dica voltados para essa demanda.

  ![Fluxo de Tranforma√ß√£o de tabelas](<dashboard/visao_regional.png>)

---

## Estrutura de Pastas do Projeto

```
üì¶ bpc-databricks-pipeline
‚îÇ
‚îú‚îÄ‚îÄ üìÅ notebooks
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ bronze
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bronze_bpc_ingestao.ipynb           # PySpark - CSV do BPC ‚Üí bronze
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bronze_censo_ingestao.ipynb         # PySpark - CSV do Censo ‚Üí bronze
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bronze_uf_municipios_ingestao.ipynb # PySpark - CSV de UF ‚Üí bronze
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ silver
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ silver_bpc_concessoes.ipynb              # PySpark - Tratamento BPC
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ silver_censo_tratado.ipynb              # PySpark - Popula√ß√£o tratada
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ silver_uf_regiao_tratado.ipynb          # PySpark - UF e regi√£o
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ silver_populacao_bpc.sql                # SQL - Uni√£o para gerar popula√ß√£o BPC
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ gold
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gold_fato_bpc_uf.sql                    # SQL - Fato por UF
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gold_fato_bpc_geral.sql                 # SQL - Fato geral
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gold_dim_uf_regiao.sql                  # SQL - Dimens√£o UF
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gold_dim_populacao.sql                  # SQL - Popula√ß√£o/p√∫blico-alvo
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gold_dim_beneficio.sql                  # SQL - Dimens√£o benef√≠cio
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ gold_dim_calendario.sql                 # SQL - Dimens√£o calend√°rio
‚îÇ   ‚îÇ
‚îú‚îÄ‚îÄ üìÅ dashboards
‚îÇ   ‚îî‚îÄ‚îÄ prints_dashboards/                          # Imagens do Power BI ou links
‚îÇ
‚îú‚îÄ‚îÄ üìÅ img
‚îÇ   ‚îú‚îÄ‚îÄ fluxo_tabelas_databricks.png                   # Fluxo visual entre tabelas
‚îÇ   ‚îî‚îÄ‚îÄ prints_tabelas/                                # Prints detalhados por camada
‚îÇ
‚îî‚îÄ‚îÄ README.md                                          # Vis√£o geral do projeto

```


