%md

# Projeto BPC - An√°lise de Judicializa√ß√£o, Cobertura e Prazos
_Dados de concess√µes BPC do primeiro semestre de 2025._

O Benef√≠cio de Presta√ß√£o Continuada (BPC) √© um dos temas mais debatidos no √¢mbito da assist√™ncia social no Brasil. Voltado para pessoas idosas ou com defici√™ncia em situa√ß√£o de vulnerabilidade, o BPC se diferencia de benef√≠cios previdenci√°rios como aposentadorias ou aux√≠lios por incapacidade, pois n√£o exige contribui√ß√£o pr√©via do benefici√°rio. Essa caracter√≠stica, somada ao seu impacto social e or√ßament√°rio, o torna alvo frequente de debates pol√≠ticos, ajustes fiscais e mudan√ßas legislativas.

A concess√£o do BPC pode ocorrer de duas formas: **administrativa**, diretamente pelo INSS, ou **judicial**, quando o pedido inicial √© negado e o requerente recorre √† Justi√ßa. A judicializa√ß√£o representa n√£o apenas um aumento da demanda para o Judici√°rio, mas tamb√©m uma oportunidade para escrit√≥rios e profissionais jur√≠dicos identificarem regi√µes com maior potencial de atua√ß√£o.

Compreender **quais regi√µes apresentam √≠ndices elevados de judicializa√ß√£o e como se comportam os indicadores de cobertura e prazos** permite tomadas de decis√£o mais estrat√©gicas. Por exemplo:

  - No **BPC-Idoso**, que possui menos barreiras t√©cnicas, regi√µes com alta judicializa√ß√£o e baixa cobertura podem sinalizar alto potencial de novas a√ß√µes.

  - No **BPC-Deficiente**, que exige per√≠cias e laudos mais complexos, indicadores como prazos m√©dios e tipo de decis√£o ajudam a identificar √°reas com maior necessidade de apoio jur√≠dico especializado.

Este projeto prop√µe uma solu√ß√£o baseada em indicadores estruturados e atualizados, permitindo monitorar a situa√ß√£o do BPC por unidade federativa e modalidade, ajudando gestores e advogados a agir de forma mais direcionada e eficaz.

---

## Tecnologias Utilizadas 

- **Databricks Free Edition** (ambiente de notebooks)
- **Pyspark, Python e SQL** (tranforma√ß√µes, limpeza, an√°lise explorat√≥ria, c√°lculos)
- **Power BI**: (visualiza√ß√£o final dos dados)
- **GitHub** (versionamento e documenta√ß√£o - integrado ao Databricks)

---

## Fonte de Dados

Os dados utilizados no projeto foram extra√≠dos de tr√™s principais fontes p√∫plicas:

- **INSS**: Tabela de concess√µes do BPC por m√™s, dispon√≠vel em csv.
 [Fonte: INSS - Dados Abertos](https://dadosabertos.inss.gov.br/dataset/beneficios-concedidos-plano-de-dados-abertos-jun-2023-a-jun-2025)
  - Quantidade de arquivos: 6 cvs - Concess√µes de jan/25 a jun/25

- **IBGE (Censo 2022)**: Popula√ß√£o total por munic√≠pio, utilizada para c√°lculo de cobertura e identifica√ß√£o do p√∫blico-alvo.  
  [Fonte: Censo IBGE 2022](https://www.ibge.gov.br/estatisticas/sociais/trabalho/22827-censo-demografico-2022.html?=&t=downloads/)
  - Quantidade de arquivos: 1 csv

- **Munic√≠pios/UF/Regi√£o**: Tabela de refer√™ncia com c√≥digos de munic√≠pios, sigla UF e regi√£o geogr√°fica.  
  [Fonte: IBGE ‚Äì Tabela de Refer√™ncia Territorial](https://www.ibge.gov.br/geociencias/organizacao-do-territorio/malhas-territoriais/15774-malhas.html/)
  - Quantidade de arquivos: 1 csv

---

## Arquitetura de dados
O pipeline foi estruturado seguindo o modelo **Medallion Architecture (Bronze, Silver, Gold)** que facilita a rastreabilidade, versionamento e reutiliza√ß√£o dos dados em m√∫ltiplos est√°gios.

![Medallion Architecture](<img/medallion.png>)

### Por que usar arquitetura em camadas?

A Medallion Architecture permite:

- **Rastreabilidade**: Cada transforma√ß√£o tem uma origem clara, facilitando auditorias.
- **Reprodutibilidade**: Permite fazer an√°lises com seguran√ßa, a partir dos dados brutos.
- **Separa√ß√£o da responsabilidade**: Cada camada tem um prop√≥sito distinto, facilitando manuten√ß√£o e escabilidade.
- **Versionamento l√≥gico**: A organiza√ß√£o em camadas ajuda a entender a evolu√ß√£o dos dados ao longo do pipeline.

---

## Camadas:

### ü•â Bronze 
- Dados brutos carregados diretamente dos arquivos CSV das fontes p√∫blicas.
- Pouco ou nenhum tratamento.
- Objetivo: manter a vers√£o original para rastreabilidade.

```
# Leitura de todos arquivos csv da pasta benef_conced contidos no volume
python
df = (
    spark.read.format("csv")
    .option("header", "true") # se tem cabe√ßalho
    .option("inferSchema", "true") # inferir o schema do arquivo csv
    .option("delimiter", ",") # delimitador do arquivo csv
    .option("encoding", "UTF-8")  # encoding do arquivo csv
    .load("dbfs:/Volumes/portfolio_inss/base_bpc/raw_uploads/censo_pop_2022.csv")
)

# Grava dados do df na tabela delta na camada bronze 

df.write.format("delta") \
    .option("overwriteSchema", "true") \
    .mode("overwrite") \
    .saveAsTable("portfolio_inss.bronze.bronze_ibge_censo_2022")
```
---

### ü•à Silver 
- Aplica√ß√£o de regras de neg√≥cios e limpeza dos dados. 
- Sele√ß√£o de colunas relevantes, padroniza√ß√£o de tipos, nomes e tipo de despacho (administrativo/judicial).


```
# Leitura da tabela delta na camada bronze

df = spark.table("portfolio_inss.bronze.bronze_inss_bpc_2025_01_06")


# Renomeando colunas

df = df.withColumnRenamed('compet√™ncia_concess√£o', 'competencia')\
       .withColumnRenamed('uf', 'uf_julgado')\
       .withColumnRenamed('esp√©cie4', 'beneficio')\
       .withColumnRenamed('dt_ddb', 'dt_despacho')\
       .withColumnRenamed('dt_dib', 'dt_inicio_beneficio')\
       .withColumnRenamed('cid6', 'cid')  


# Convers√£o de datas

df = df.withColumn("competencia", to_date(expr("concat(competencia, '01')"),"yyyyMMdd"))\
        .withColumn("dt_nascimento", to_date(df.dt_nascimento, "dd/MM/yyyy"))\
        .withColumn("dt_despacho", to_date(df.dt_despacho, "dd/MM/yyyy"))\
        .withColumn("dt_inicio_beneficio", to_date(df.dt_inicio_beneficio, "dd/MM/yyyy"))


# Grava dados do df na tabela delta na camada silver

df_result.write.format("delta")\
    .mode("overwrite")\
    .saveAsTable("portfolio_inss.silver.silver_bpc_concessoes")
```

#### Estrutura das Tabelas Silver
- [Baixar Dicion√°rio Silver](https://github.com/fdg-fer/bpc-pipeline-databricks/blob/main/dic/silver.xlsx)

---
### ü•á Camada Gold

Nesta camada, os dados j√° passaram por limpeza e transforma√ß√µes, estando prontos para **consumo final** em dashboards, relat√≥rios e an√°lises explorat√≥rias.  
A modelagem segue o formato **Star Schema**, com tabelas fato e tabelas dimens√£o, permitindo consultas otimizadas e agrega√ß√µes consistentes.

#### Objetivos
- Consolidar informa√ß√µes calculadas e agregadas.
- Organizar dados para f√°cil integra√ß√£o com ferramentas de BI.
- Garantir consist√™ncia em m√©tricas como **cobertura**, **prazos m√©dios/medianos** e segmenta√ß√µes por UF e p√∫blico-alvo.


 
```
# Cria a tabela p√∫plivo alvo BPC granularidade por UF a partir do censo IBGE 2022
# P√∫blico >= 65 BPC Idoso
# P√∫blico < 65 BPC Deficiente

query =  """

CREATE OR REPLACE TABLE portfolio_inss.gold.gold_fato_populacao_bpc as(

WITH 
  bpc AS (
      SELECT 
        uf_final,
        beneficio,
        SUM(qtd_total_concedido) AS qtd_beneficio_bpc,
        count(distinct competencia) as qtd_competencias,
        round(qtd_beneficio_bpc/qtd_competencias, 0) as media_beneficio
      FROM portfolio_inss.gold.gold_bpc_uf
      where competencia >= '2025-01-01'
      GROUP BY
        uf_final, beneficio
  ), 
  populacao_bpc AS (
      SELECT 
        sigla_uf,
        nome_uf,
        SUM(CASE WHEN idade_anos < 65 THEN populacao ELSE 0 END) AS populacao_deficiente,
        SUM(CASE WHEN idade_anos >= 65 THEN populacao ELSE 0 END) AS populacao_idosa
      FROM portfolio_inss.silver.silver_ibge_populacao_uf
      GROUP BY sigla_uf ,nome_uf
  )
SELECT 
    p.sigla_uf,
    b.uf_final,
    b.beneficio,
    b.qtd_beneficio_bpc,
    b.media_beneficio,
    CASE 
        WHEN b.beneficio = 'Amp. Social Pessoa Portadora Deficiencia' THEN p.populacao_deficiente
        WHEN b.beneficio = 'Amparo Social ao Idoso' THEN p.populacao_idosa
        ELSE NULL
    END AS populacao_alvo
FROM bpc b
LEFT JOIN populacao_bpc p
    ON b.uf_final = p.nome_uf
)
"""
spark.sql(query)
```

#### Estrutura das Tabelas Gold
- [Baixar Dicion√°rio Gold](https://github.com/fdg-fer/bpc-pipeline-databricks/blob/main/dic/gold.xlsx)

**Tabelas Fato**

As tabelas Fato BPC re√∫nem informa√ß√µes consolidadas sobre solicita√ß√µes e concess√µes do BPC, filtradas de acordo com o crit√©rio temporal definido para a an√°lise: consideram-se apenas processos cuja data de entrada seja igual ou posterior a 01/01/2024.
Esse recorte temporal √© aplicado para assegurar que a an√°lise se concentre em pedidos recentes, possibilitando a avalia√ß√£o de prazos e perfis de concess√£o.

- **Fato BPC Geral** ‚Äì Dados consolidados do BPC em n√≠vel nacional, com m√©tricas de cobertura e prazos.

  ![Fato BPC Geral](<img/fato_bpc_geral.png>)

- **Fato BPC por UF** ‚Äì Mesma granularidade da tabela geral, mas segmentada por Unidade Federativa.

  ![Fato BPC por UF](<img/fato_bpc_uf.png>) 

- **Fato Popula√ß√£o/P√∫blico-alvo** ‚Äì Informa√ß√µes demogr√°ficas e quantitativas sobre o p√∫blico-alvo do benef√≠cio.

  ![Fato Popula√ß√£o](<img/fato_populacao.png>)

**Tabelas Dimens√£o**
- **Dimens√£o Calend√°rio** ‚Äì Datas de refer√™ncia para an√°lises temporais (ano, m√™s, trimestre, etc.).

  ![Dimens√£o Calend√°rio](<img/dim_calendario.png>)

- **Dimens√£o Benef√≠cio** ‚Äì Classifica√ß√£o e tipo de benef√≠cio dentro do BPC.

  ![Dimens√£o Benef√≠cio](<img/dim_beneficio.png>)

- **Dimens√£o UF/Regi√£o** ‚Äì Mapeamento de Unidades Federativas para suas respectivas regi√µes.

  ![Dimens√£o UF/Regi√£o](<img/dim_uf.png>)

#### Exemplos de Uso
- C√°lculo de cobertura por UF ao longo do tempo.
- Compara√ß√£o de prazos m√©dios administrativos e judiciais.
- Dashboards interativos no Power BI segmentados por regi√£o e p√∫blico.

---

## Fluxo de Transforma√ß√£o Databricks

Abaixo, o fluxo visual que mostra a transforma√ß√£o dos dados da camada Bronze at√© a Gold:

Fluxo de camadas da tabela BPC

- **Volume**
  - `6 arquivos csv`
- **Bronze**
  - Tabela:`bronze_inss_bpc_2025_01_06`
- **Silver**
  - Tabela:`silver_bpc_concessoes`
- **Gold**
  - Tabela:`gold_fato_bpc_uf`
  - Tabela:`gold_fato_bpc_geral`

  ![Fluxo de Tranforma√ß√£o de tabelas](<img/fluxo_bpc.png>)

Fluxo de  camadas da tabela Popula√ß√£o PBC 

- **Volume**
  - `2 arquivos csv`
- **Bronze**
  - Tabela:`bronze_inss_bpc_2025_01_06`
- **Silver**
  - Tabela:`silver_bpc_concessoes`
- **Gold**
  - Tabela:`gold_fato_bpc_uf`
  - Tabela:`gold_fato_bpc_geral`

  ![Fluxo de Tranforma√ß√£o de tabelas](<img/fluxo_populacao_bpc.png>)

---

## Estrutura de Pastas do Projeto

```
üì¶ bpc-databricks-pipeline
‚îÇ
‚îú‚îÄ‚îÄ üìÅ notebooks
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ bronze
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bronze_bpc_ingestao.ipynb           # PySpark - CSV do BPC ‚Üí bronze
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bronze_censo_ingestao.ipynb         # PySpark - CSV do Censo ‚Üí bronze
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bronze_uf_municipios_ingestao.ipynb # PySpark - CSV de UF ‚Üí bronze
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ silver
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ silver_bpc_concessoes.ipynb              # PySpark - Tratamento BPC
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ silver_censo_tratado.ipynb              # PySpark - Popula√ß√£o tratada
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ silver_uf_regiao_tratado.ipynb          # PySpark - UF e regi√£o
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ silver_populacao_bpc.sql                # SQL - Uni√£o para gerar popula√ß√£o BPC
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ gold
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gold_fato_bpc_uf.sql                    # SQL - Fato por UF
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gold_fato_bpc_geral.sql                 # SQL - Fato geral
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gold_dim_uf_regiao.sql                  # SQL - Dimens√£o UF
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gold_dim_populacao.sql                  # SQL - Popula√ß√£o/p√∫blico-alvo
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gold_dim_beneficio.sql                  # SQL - Dimens√£o benef√≠cio
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ gold_dim_calendario.sql                 # SQL - Dimens√£o calend√°rio
‚îÇ   ‚îÇ
‚îú‚îÄ‚îÄ üìÅ dashboards
‚îÇ   ‚îî‚îÄ‚îÄ prints_dashboards/                          # Imagens do Power BI ou links
‚îÇ
‚îú‚îÄ‚îÄ üìÅ img
‚îÇ   ‚îú‚îÄ‚îÄ fluxo_tabelas_databricks.png                   # Fluxo visual entre tabelas
‚îÇ   ‚îî‚îÄ‚îÄ prints_tabelas/                                # Prints detalhados por camada
‚îÇ
‚îî‚îÄ‚îÄ README.md                                          # Vis√£o geral do projeto

```


